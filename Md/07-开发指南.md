# 2D Fighter 开发指南

## 开发环境搭建

### 客户端开发环境

#### 必需软件

1. **Unity Hub**
   - 下载地址：https://unity.com/download
   - 版本：最新版本

2. **Unity Editor**
   - 版本：2022.3 LTS 或更高
   - 安装模块：
     - Windows Build Support
     - Mac Build Support（可选）
     - Linux Build Support（可选）
     - Android Build Support（可选）

3. **IDE（选择其一）**
   - **Visual Studio 2022**
     - 下载地址：https://visualstudio.microsoft.com/
     - 工作负载：使用Unity的游戏开发
   - **JetBrains Rider**
     - 下载地址：https://www.jetbrains.com/rider/
     - 推荐用于C#开发

4. **Git**
   - 下载地址：https://git-scm.com/
   - 用于版本控制

#### 环境配置

1. **克隆项目**
   ```bash
   git clone https://github.com/Wangok123/2d_Fighter.git
   cd 2d_Fighter
   ```

2. **打开Unity项目**
   - 启动Unity Hub
   - 点击"添加"，选择 `Client` 目录
   - 等待Unity导入项目

3. **配置IDE**
   - Unity → Preferences → External Tools
   - 选择External Script Editor为你的IDE
   - 推荐Rider或Visual Studio

4. **验证环境**
   - 打开任意脚本，确保IDE正确打开
   - 在Unity中点击Play，确保项目能正常运行

### 服务器开发环境

#### 必需软件

1. **.NET SDK**
   - 版本：.NET 6.0 或更高
   - 下载地址：https://dotnet.microsoft.com/download
   - 验证安装：
     ```bash
     dotnet --version
     ```

2. **IDE（选择其一）**
   - **Visual Studio 2022**
   - **JetBrains Rider**
   - **Visual Studio Code**（需安装C#扩展）

#### 环境配置

1. **打开服务器项目**
   ```bash
   cd Server/LatServer
   ```

2. **恢复NuGet包**
   ```bash
   dotnet restore
   ```

3. **编译项目**
   ```bash
   dotnet build
   ```

4. **运行服务器**
   ```bash
   cd LatServer
   dotnet run
   ```

## 项目结构说明

### 客户端目录结构

```
Client/
├── Assets/
│   ├── Scripts/           # 游戏脚本
│   │   ├── Core/          # 核心框架
│   │   ├── UnityCore/     # Unity框架
│   │   └── Gen/           # 生成代码
│   ├── Resources/         # 资源文件
│   ├── Scenes/            # 场景文件
│   ├── Prefabs/           # 预制体
│   ├── ThirdParty/        # 第三方插件
│   └── StreamingAssets/   # 流资源
├── Packages/              # Unity包
└── ProjectSettings/       # 项目设置
```

### 服务器目录结构

```
Server/LatServer/
├── LatNet/               # 网络层
├── LatProtocol/          # 协议层
└── LatServer/            # 业务层
    └── Core/
        ├── Common/       # 通用模块
        ├── Service/      # 业务服务
        └── System/       # 系统模块
```

## 开发工作流

### 1. 创建新功能

#### 客户端新功能

1. **创建脚本**
   ```csharp
   // 在合适的目录下创建新脚本
   // 例如：Assets/Scripts/UnityCore/GameModule/MyFeature.cs
   
   public class MyFeature : MonoBehaviour
   {
       void Start()
       {
           // 初始化代码
       }
   }
   ```

2. **添加到场景**
   - 将脚本挂载到GameObject
   - 配置Inspector参数

3. **集成到框架**
   - 如果是Manager类，继承单例基类
   - 在GameLauncher或BaseScene中初始化

#### 服务器新功能

1. **创建Service**
   ```csharp
   // Server/LatServer/LatServer/Core/Service/MyService.cs
   
   public class MyService
   {
       public void Initialize()
       {
           // 初始化代码
       }
       
       public void Update()
       {
           // 更新代码
       }
   }
   ```

2. **注册Service**
   ```csharp
   // 在ServerRoot中注册
   private MyService _myService;
   
   public void Init()
   {
       _myService = new MyService();
       _myService.Initialize();
   }
   ```

### 2. 添加新协议

1. **定义Protobuf协议**
   ```protobuf
   // Protocal/Proto/myfeature.proto
   syntax = "proto3";
   package GameProtocol;
   
   message MyFeatureRequest {
       int32 param1 = 1;
       string param2 = 2;
   }
   
   message MyFeatureResponse {
       int32 error_code = 1;
       string result = 2;
   }
   ```

2. **生成C#代码**
   ```bash
   cd Protocal
   protoc --csharp_out=../Client/Assets/Scripts/Gen/Proto *.proto
   protoc --csharp_out=../Server/LatServer/LatProtocol/Protocol *.proto
   ```

3. **添加协议ID**
   ```csharp
   // Server/LatServer/LatProtocol/ProtocolID.cs
   public enum ProtocolID
   {
       // ...
       MyFeatureRequest = 100,
       MyFeatureResponse = 101,
   }
   ```

4. **实现处理器**
   ```csharp
   // 服务器端
   public void HandleMyFeatureRequest(KCPSession session, MyFeatureRequest request)
   {
       // 处理逻辑
       var response = new MyFeatureResponse
       {
           ErrorCode = 0,
           Result = "Success"
       };
       
       ProtocolManager.SendMessage(session, response);
   }
   
   // 客户端
   public void OnMyFeatureResponse(MyFeatureResponse response)
   {
       if (response.ErrorCode == 0)
       {
           Debug.Log($"Success: {response.Result}");
       }
   }
   ```

### 3. 添加配置表

1. **创建Excel配置表**
   - 在配置表目录创建Excel文件
   - 定义表结构

2. **使用Luban生成代码**
   ```bash
   # 运行Luban工具
   luban -t client -c cs-bin -d bin
   ```

3. **加载配置**
   ```csharp
   // 在ConfigManager中加载
   var config = ConfigManager.Instance.GetConfig<MyConfig>(configId);
   ```

### 4. 创建UI界面

1. **创建UI预制体**
   - 在Unity中创建UI Canvas
   - 设计UI布局
   - 保存为Prefab

2. **创建UI脚本**
   ```csharp
   public class MyUI : UIBase
   {
       [SerializeField] private Button closeButton;
       [SerializeField] private Text titleText;
       
       public override void OnInit()
       {
           closeButton.onClick.AddListener(OnCloseClick);
       }
       
       public override void OnOpen()
       {
           titleText.text = "My UI";
       }
       
       private void OnCloseClick()
       {
           UIManager.Instance.CloseUI("MyUI");
       }
   }
   ```

3. **打开UI**
   ```csharp
   await UIManager.Instance.OpenUIAsync<MyUI>("MyUI");
   ```

## 调试技巧

### 客户端调试

#### 1. Unity调试

```csharp
// 使用Debug.Log
Debug.Log("Normal log");
Debug.LogWarning("Warning log");
Debug.LogError("Error log");

// 使用断点
// 在IDE中设置断点，然后Attach to Unity
```

#### 2. 场景调试

- 使用Gizmos可视化
  ```csharp
  void OnDrawGizmos()
  {
      Gizmos.color = Color.red;
      Gizmos.DrawWireSphere(transform.position, radius);
  }
  ```

- 使用Scene视图调试
  - 在Scene视图中观察对象位置
  - 使用Game Object → Align View to Selected

#### 3. 性能调试

- 使用Profiler（Window → Analysis → Profiler）
- 关注CPU、GPU、内存使用
- 查找性能瓶颈

#### 4. 网络调试

```csharp
// 启用网络日志
NetworkManager.Instance.EnableDebugLog = true;

// 查看发送/接收的消息
```

### 服务器调试

#### 1. Visual Studio调试

- 设置断点
- F5启动调试
- 查看变量值

#### 2. 日志调试

```csharp
// 使用Console输出
Console.WriteLine($"[Debug] User {userId} connected");

// 使用日志框架
Logger.Info($"User {userId} connected");
Logger.Error($"Error occurred: {ex.Message}");
```

#### 3. 网络抓包

- 使用Wireshark抓取UDP包
- 过滤器：`udp.port == 5000`
- 分析网络流量

## 测试指南

### 单元测试

#### 客户端单元测试

```csharp
// 使用Unity Test Framework
[Test]
public void TestObjectPool()
{
    var pool = new ObjectPool<TestObject>();
    var obj = pool.Get();
    Assert.IsNotNull(obj);
    pool.Release(obj);
}
```

#### 服务器单元测试

```csharp
// 使用xUnit或NUnit
[Fact]
public void TestLoginService()
{
    var service = new LoginService();
    var result = service.ValidateUser("testuser");
    Assert.True(result);
}
```

### 集成测试

1. **启动服务器**
   ```bash
   cd Server/LatServer/LatServer
   dotnet run
   ```

2. **启动多个客户端**
   - 使用ParrelSync创建项目副本
   - 同时运行多个Unity实例
   - 测试多人功能

### 压力测试

1. **创建机器人客户端**
   - 模拟大量客户端连接
   - 自动化操作

2. **监控服务器性能**
   - CPU使用率
   - 内存占用
   - 网络带宽

## 代码规范

### 命名规范

```csharp
// 类名：PascalCase
public class PlayerController { }

// 方法名：PascalCase
public void MovePlayer() { }

// 公共字段/属性：PascalCase
public int Health { get; set; }

// 私有字段：_camelCase
private int _maxHealth;

// 局部变量：camelCase
var playerHealth = 100;

// 常量：UPPER_SNAKE_CASE
public const int MAX_PLAYERS = 10;

// 接口：IPascalCase
public interface IMovable { }
```

### 注释规范

```csharp
/// <summary>
/// 玩家控制器类
/// </summary>
public class PlayerController
{
    /// <summary>
    /// 移动玩家到指定位置
    /// </summary>
    /// <param name="position">目标位置</param>
    /// <param name="speed">移动速度</param>
    public void MoveTo(Vector3 position, float speed)
    {
        // 计算方向
        var direction = (position - transform.position).normalized;
        
        // TODO: 添加碰撞检测
        
        // 移动
        transform.position += direction * speed * Time.deltaTime;
    }
}
```

### 代码组织

```csharp
public class MyClass
{
    // 1. 常量
    private const int MAX_VALUE = 100;
    
    // 2. 静态字段
    private static MyClass _instance;
    
    // 3. 序列化字段
    [SerializeField] private GameObject prefab;
    
    // 4. 私有字段
    private int _value;
    
    // 5. 属性
    public int Value { get; set; }
    
    // 6. Unity消息
    void Awake() { }
    void Start() { }
    void Update() { }
    
    // 7. 公共方法
    public void DoSomething() { }
    
    // 8. 私有方法
    private void Helper() { }
}
```

## 版本控制

### Git工作流

1. **创建功能分支**
   ```bash
   git checkout -b feature/my-feature
   ```

2. **提交代码**
   ```bash
   git add .
   git commit -m "Add my feature"
   ```

3. **推送到远程**
   ```bash
   git push origin feature/my-feature
   ```

4. **创建Pull Request**
   - 在GitHub上创建PR
   - 等待代码审查
   - 合并到主分支

### 提交信息规范

```
<type>: <subject>

<body>

<footer>
```

类型（type）：
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式
- refactor: 重构
- test: 测试
- chore: 构建/工具

示例：
```
feat: Add player skill system

- Implement skill manager
- Add skill configuration
- Create skill UI

Closes #123
```

## 常见问题

### Q1: Unity项目打不开？
A: 
1. 检查Unity版本是否正确
2. 删除Library文件夹，重新导入
3. 检查.gitignore是否正确

### Q2: 编译错误？
A:
1. 清理项目（Build → Clean）
2. 重新生成协议代码
3. 检查依赖包是否正确安装

### Q3: 网络连接失败？
A:
1. 检查服务器是否启动
2. 检查IP和端口配置
3. 检查防火墙设置

### Q4: 资源加载失败？
A:
1. 检查资源路径是否正确
2. 检查资源是否打包到AB中
3. 检查YooAsset配置

## 相关文档

- [项目总览](01-项目总览.md)
- [技术栈详解](02-技术栈.md)
- [客户端架构](03-客户端架构.md)
- [服务端架构](04-服务端架构.md)
- [API文档](06-API文档.md)
- [部署指南](08-部署指南.md)
