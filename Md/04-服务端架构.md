# 2D Fighter 服务端架构

## 架构概览

服务端采用分层架构设计，基于.NET 6.0开发，使用KCP协议实现低延迟网络通信。

```
┌─────────────────────────────────────────────┐
│         Application Layer (业务层)           │
│    Login, Match, Battle, User Management   │
└─────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────┐
│        Service Layer (服务层)                │
│   MessageHandler, System Services, Tools   │
└─────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────┐
│        Protocol Layer (协议层)               │
│  ProtocolManager, ProtocolMapping, Codec   │
└─────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────┐
│         Network Layer (网络层)               │
│      KCP, Session Management, Handle       │
└─────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────┐
│            Transport Layer (传输层)          │
│              UDP Socket, KCP                │
└─────────────────────────────────────────────┘
```

## 项目结构

```
Server/LatServer/
├── LatNet/                  # 网络通信层
│   ├── KCPNet.cs           # KCP网络管理
│   ├── KCPSession.cs       # KCP会话
│   ├── KCPHandle.cs        # KCP处理器
│   └── KCPTool.cs          # KCP工具类
├── LatProtocol/            # 协议层
│   ├── ProtocolID.cs       # 协议ID定义
│   ├── ErrorCodeID.cs      # 错误码定义
│   ├── ProtobufHelper.cs   # Protobuf辅助类
│   ├── ProtocolMapping.cs  # 协议映射
│   ├── ProtocolManager.cs  # 协议管理器
│   ├── ServerConfig.cs     # 服务器配置
│   ├── ProtocolProcessor.cs # 协议处理器
│   └── Protocol/           # 协议定义
│       ├── Login.cs        # 登录协议
│       ├── Common.cs       # 通用协议
│       ├── Battle.cs       # 战斗协议
│       ├── Operation.cs    # 操作协议
│       └── Match.cs        # 匹配协议
└── LatServer/              # 服务器核心
    ├── Core/               # 核心模块
    │   ├── Common/         # 通用模块
    │   │   └── ServerStart.cs # 服务器启动
    │   ├── Gen/            # 生成代码
    │   ├── MessageHandleService/ # 消息处理服务
    │   ├── Service/        # 业务服务
    │   ├── System/         # 系统模块
    │   └── Tools/          # 工具类
    └── Tools/              # 工具脚本
        └── ProtobufToCSharp.cs # Protobuf转C#
```

## 网络层（LatNet）

### 1. KCPNet（KCP网络管理器）

**文件**：`LatNet/KCPNet.cs`

**职责**：
- KCP网络初始化
- 监听连接
- 会话管理
- 网络更新循环

**核心功能**：
```csharp
// 启动服务器
public void Start(string host, int port)

// 网络更新（需要定期调用）
public void Update()

// 关闭服务器
public void Shutdown()
```

**特性**：
- 基于UDP的可靠传输
- 低延迟优化
- 自动重传机制
- 拥塞控制

### 2. KCPSession（KCP会话）

**文件**：`LatNet/KCPSession.cs`

**职责**：
- 管理单个客户端连接
- 消息收发
- 心跳检测
- 断线处理

**核心功能**：
```csharp
// 发送消息
public void Send(byte[] data)

// 接收消息
public byte[] Receive()

// 断开连接
public void Disconnect()
```

**会话状态**：
- Connected（已连接）
- Disconnected（已断开）
- Timeout（超时）

### 3. KCPHandle（KCP处理器）

**文件**：`LatNet/KCPHandle.cs`

**职责**：
- KCP事件处理
- 连接建立
- 数据接收
- 异常处理

**处理流程**：
```
客户端连接
   ↓
创建KCPSession
   ↓
添加到会话管理器
   ↓
开始接收数据
   ↓
分发到协议层
```

### 4. KCPTool（KCP工具类）

**文件**：`LatNet/KCPTool.cs`

**职责**：
- KCP配置
- 性能参数调优
- 辅助函数

**KCP参数优化**：
```csharp
// 快速模式配置
nodelay: 1      // 启用快速重传
interval: 10    // 更新间隔10ms
resend: 2       // 快速重传触发倍数
nc: 1           // 关闭拥塞控制
```

## 协议层（LatProtocol）

### 1. ProtocolID（协议ID）

**文件**：`LatProtocol/ProtocolID.cs`

**定义的协议**：
```csharp
public enum ProtocolID
{
    // 战斗相关
    BattleStartRequest = 1,         // 战斗开始请求
    SendOperationKeyRequest = 2,    // 发送操作键请求
    OperationKeyNotification = 3,   // 操作键通知
    
    // 登录相关
    LoginRequest = 4,               // 登录请求
    LoginResponse = 5,              // 登录响应
    
    // 匹配相关
    MatchRequest = 6,               // 匹配请求
    MatchResponse = 7,              // 匹配响应
    ConfirmNotification = 8,        // 确认通知
    SendConfirmRequest = 9,         // 发送确认请求
    SelectNotification = 10,        // 选择通知
    SendSelectRequest = 11,         // 发送选择请求
    
    // 加载相关
    SendLoadProgressRequest = 12,   // 发送加载进度请求
    LoadProgressNotification = 13,  // 加载进度通知
    LoadResourceNotification = 14,  // 加载资源通知
    LoadingFinishRequest = 15,      // 加载完成请求
    LoadingFinishNotification = 16, // 加载完成通知
}
```

### 2. ErrorCodeID（错误码）

**文件**：`LatProtocol/ErrorCodeID.cs`

**错误码定义**：
- 成功码
- 网络错误
- 业务错误
- 系统错误

**使用示例**：
```csharp
public enum ErrorCodeID
{
    Success = 0,
    NetworkError = 1000,
    LoginFailed = 2000,
    MatchTimeout = 3000,
    BattleError = 4000,
}
```

### 3. ProtobufHelper（Protobuf辅助类）

**文件**：`LatProtocol/ProtobufHelper.cs`

**功能**：
- 消息序列化
- 消息反序列化
- 类型转换

**使用示例**：
```csharp
// 序列化
byte[] data = ProtobufHelper.Serialize(message);

// 反序列化
var message = ProtobufHelper.Deserialize<LoginRequest>(data);
```

### 4. ProtocolMapping（协议映射）

**文件**：`LatProtocol/ProtocolMapping.cs`

**功能**：
- 协议ID到消息类型的映射
- 消息类型到协议ID的映射
- 快速查找

**映射表**：
```csharp
// 协议ID -> 消息类型
Dictionary<ProtocolID, Type> _protocolToType;

// 消息类型 -> 协议ID
Dictionary<Type, ProtocolID> _typeToProtocol;
```

### 5. ProtocolManager（协议管理器）

**文件**：`LatProtocol/ProtocolManager.cs`

**职责**：
- 协议注册
- 消息分发
- 处理器管理

**核心流程**：
```
接收字节流
   ↓
解析协议ID
   ↓
反序列化消息
   ↓
查找处理器
   ↓
执行处理器
   ↓
返回响应
```

### 6. ProtocolProcessor（协议处理器）

**文件**：`LatProtocol/ProtocolProcessor.cs`

**功能**：
- 消息处理基类
- 处理器接口定义

### 7. ServerConfig（服务器配置）

**文件**：`LatProtocol/ServerConfig.cs`

**配置项**：
```csharp
public class ServerConfig
{
    public string Host { get; set; }        // 服务器地址
    public int Port { get; set; }           // 服务器端口
    public int MaxConnections { get; set; } // 最大连接数
    public int Timeout { get; set; }        // 超时时间
}
```

### 8. Protocol目录（协议定义）

#### Login.cs（登录协议）
```protobuf
// 登录请求
message LoginRequest {
    string username = 1;
}

// 登录响应
message LoginResponse {
    uint64 user_id = 1;
    string username = 2;
}
```

#### Common.cs（通用协议）
```protobuf
// 用户DTO
message UserDto {
    uint64 user_id = 1;
    string username = 2;
    int32 level = 3;
    uint32 exp = 4;
}

// 英雄DTO
message HeroDto {
    int32 hero_id = 1;
}
```

#### Battle.cs（战斗协议）
- 战斗开始
- 操作指令
- 战斗结果

#### Operation.cs（操作协议）
- 玩家操作
- 移动指令
- 技能释放

#### Match.cs（匹配协议）
- 匹配请求
- 匹配成功
- 匹配取消

## 服务器核心（LatServer）

### 1. ServerStart（服务器启动）

**文件**：`LatServer/Core/Common/ServerStart.cs`

**启动流程**：
```csharp
public static void Main(string[] args)
{
    // 1. 初始化服务器
    ServerRoot.Instance.Init();

    // 2. 主循环
    while (true)
    {
        // 更新服务器
        ServerRoot.Instance.Update();
        
        // 短暂休眠，避免CPU占用过高
        Thread.Sleep(10);
    }
}
```

### 2. ServerRoot（服务器根）

**职责**：
- 管理所有服务器模块
- 统一的更新入口
- 生命周期管理

**主要模块**：
```csharp
public class ServerRoot
{
    private KCPNet _network;              // 网络模块
    private ProtocolManager _protocol;    // 协议模块
    private LoginService _loginService;   // 登录服务
    private MatchService _matchService;   // 匹配服务
    private BattleService _battleService; // 战斗服务
}
```

### 3. MessageHandleService（消息处理服务）

**路径**：`LatServer/Core/MessageHandleService/`

**职责**：
- 消息路由
- 处理器调用
- 异常捕获

**处理流程**：
```
接收消息
   ↓
验证消息格式
   ↓
查找处理器
   ↓
调用处理器
   ↓
捕获异常
   ↓
返回结果
```

### 4. Service（业务服务）

**路径**：`LatServer/Core/Service/`

#### LoginService（登录服务）
**功能**：
- 用户登录验证
- 用户信息管理
- Session绑定

#### MatchService（匹配服务）
**功能**：
- 匹配队列管理
- 匹配算法
- 匹配通知

**匹配流程**：
```
玩家发起匹配
   ↓
加入匹配队列
   ↓
匹配算法计算
   ↓
找到对手
   ↓
通知双方
   ↓
确认匹配
   ↓
进入战斗房间
```

#### BattleService（战斗服务）
**功能**：
- 战斗房间管理
- 战斗逻辑
- 帧同步
- 战斗结算

**战斗流程**：
```
创建战斗房间
   ↓
玩家加入房间
   ↓
选择英雄
   ↓
加载资源
   ↓
战斗开始
   ↓
接收操作指令
   ↓
广播给所有玩家
   ↓
战斗结束
   ↓
结算奖励
```

### 5. System（系统模块）

**路径**：`LatServer/Core/System/`

**包含**：
- 定时器系统
- 日志系统
- 配置系统
- 数据库系统（如果有）

### 6. Tools（工具类）

**路径**：`LatServer/Core/Tools/`

**包含**：
- 辅助工具
- 调试工具
- 性能分析工具

## 核心业务流程

### 登录流程

```
客户端连接服务器
   ↓
发送LoginRequest
   ↓
服务器验证用户名
   ↓
生成用户ID
   ↓
返回LoginResponse
   ↓
客户端保存用户信息
```

### 匹配流程

```
客户端发送MatchRequest
   ↓
服务器将玩家加入匹配队列
   ↓
匹配算法运行
   ↓
找到合适的对手
   ↓
发送MatchResponse给双方
   ↓
双方发送ConfirmNotification
   ↓
进入英雄选择
   ↓
双方发送SelectNotification
   ↓
开始加载战斗资源
```

### 战斗流程

```
服务器发送LoadResourceNotification
   ↓
客户端加载资源
   ↓
客户端发送LoadProgressNotification
   ↓
所有玩家加载完成
   ↓
服务器发送LoadingFinishNotification
   ↓
战斗开始（BattleStartRequest）
   ↓
客户端发送操作（SendOperationKeyRequest）
   ↓
服务器广播操作（OperationKeyNotification）
   ↓
客户端模拟战斗
   ↓
战斗结束
   ↓
结算奖励
```

## 网络通信机制

### 1. 帧同步
- 客户端发送操作指令
- 服务器广播给所有玩家
- 客户端本地模拟计算结果
- 保证确定性

### 2. 心跳机制
- 定期发送心跳包
- 检测连接状态
- 超时自动断开

### 3. 重连机制
- 保存玩家状态
- 支持断线重连
- 恢复战斗进度

## 性能优化

### 1. 网络优化
- KCP快速模式
- 消息合并
- 压缩传输

### 2. 内存优化
- 对象池
- 及时释放资源
- 避免内存泄漏

### 3. CPU优化
- 避免频繁GC
- 优化算法复杂度
- 多线程处理（如果需要）

## 安全性

### 1. 输入验证
- 验证所有客户端输入
- 防止非法数据

### 2. 防作弊
- 服务器权威
- 关键逻辑服务器计算
- 数据加密

### 3. 异常处理
- Try-Catch包装
- 日志记录
- 优雅降级

## 监控和日志

### 1. 日志系统
- 分级别日志
- 日志文件
- 错误追踪

### 2. 性能监控
- CPU使用率
- 内存占用
- 网络流量
- 在线人数

## 部署架构

```
┌─────────────┐
│   客户端A    │
└──────┬──────┘
       │
       ↓
┌─────────────────────┐
│   负载均衡（可选）    │
└──────┬──────────────┘
       │
       ↓
┌─────────────────────┐
│   游戏服务器集群     │
│  ┌────┐ ┌────┐      │
│  │GS1 │ │GS2 │ ...  │
│  └────┘ └────┘      │
└─────────────────────┘
```

## 扩展性设计

### 1. 横向扩展
- 支持多服务器部署
- 负载均衡
- 动态扩容

### 2. 纵向扩展
- 模块化设计
- 易于添加新功能
- 插件化架构

## 相关文档

- [项目总览](01-项目总览.md)
- [技术栈详解](02-技术栈.md)
- [客户端架构](03-客户端架构.md)
- [网络通信协议](05-网络通信协议.md)
- [API文档](06-API文档.md)
