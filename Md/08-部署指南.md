# 2D Fighter 部署指南

## 部署概述

本文档介绍如何部署2D Fighter项目的客户端和服务器。

## 服务器部署

### 部署环境要求

#### 硬件要求
- **CPU**：2核心及以上
- **内存**：4GB及以上
- **磁盘**：10GB可用空间
- **网络**：稳定的网络连接，建议10Mbps以上

#### 软件要求
- **操作系统**：
  - Windows Server 2016及以上
  - Ubuntu 18.04 LTS及以上
  - CentOS 7及以上
- **.NET运行时**：.NET 6.0或更高版本

### Linux服务器部署

#### 1. 安装.NET运行时

```bash
# Ubuntu/Debian
wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
rm packages-microsoft-prod.deb

sudo apt-get update
sudo apt-get install -y dotnet-runtime-6.0

# CentOS/RHEL
sudo rpm -Uvh https://packages.microsoft.com/config/centos/7/packages-microsoft-prod.rpm
sudo yum install dotnet-runtime-6.0
```

#### 2. 上传服务器文件

```bash
# 在本地编译项目
cd Server/LatServer/LatServer
dotnet publish -c Release -o ./publish

# 压缩发布文件
tar -czf latserver.tar.gz ./publish

# 上传到服务器（使用scp）
scp latserver.tar.gz user@server:/opt/latserver/

# 在服务器上解压
ssh user@server
cd /opt/latserver
tar -xzf latserver.tar.gz
```

#### 3. 配置服务器

```bash
# 创建配置文件
nano /opt/latserver/publish/config.json
```

配置文件示例：
```json
{
  "ServerConfig": {
    "Host": "0.0.0.0",
    "Port": 5000,
    "MaxConnections": 1000,
    "Timeout": 30000
  },
  "LogConfig": {
    "Level": "Info",
    "FilePath": "/var/log/latserver/"
  }
}
```

#### 4. 配置防火墙

```bash
# Ubuntu (UFW)
sudo ufw allow 5000/udp
sudo ufw reload

# CentOS (firewalld)
sudo firewall-cmd --permanent --add-port=5000/udp
sudo firewall-cmd --reload
```

#### 5. 创建systemd服务

```bash
# 创建服务文件
sudo nano /etc/systemd/system/latserver.service
```

服务文件内容：
```ini
[Unit]
Description=LAT Game Server
After=network.target

[Service]
Type=simple
User=gameserver
WorkingDirectory=/opt/latserver/publish
ExecStart=/usr/bin/dotnet /opt/latserver/publish/LatServer.dll
Restart=always
RestartSec=10
SyslogIdentifier=latserver

# 环境变量
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

# 资源限制
LimitNOFILE=65536
LimitNPROC=4096

[Install]
WantedBy=multi-user.target
```

#### 6. 启动服务

```bash
# 创建专用用户
sudo useradd -r -s /bin/false gameserver
sudo chown -R gameserver:gameserver /opt/latserver

# 重载systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start latserver

# 设置开机自启
sudo systemctl enable latserver

# 查看服务状态
sudo systemctl status latserver

# 查看日志
sudo journalctl -u latserver -f
```

### Windows服务器部署

#### 1. 安装.NET运行时

1. 下载.NET 6.0 Runtime：https://dotnet.microsoft.com/download/dotnet/6.0
2. 运行安装程序
3. 验证安装：`dotnet --version`

#### 2. 发布程序

```powershell
# 在项目目录下
cd Server\LatServer\LatServer
dotnet publish -c Release -o .\publish
```

#### 3. 配置Windows服务

使用NSSM（Non-Sucking Service Manager）：

```powershell
# 下载NSSM
# https://nssm.cc/download

# 安装服务
nssm install LatServer "C:\dotnet\dotnet.exe" "C:\LatServer\LatServer.dll"

# 设置工作目录
nssm set LatServer AppDirectory "C:\LatServer"

# 设置日志
nssm set LatServer AppStdout "C:\LatServer\logs\output.log"
nssm set LatServer AppStderr "C:\LatServer\logs\error.log"

# 启动服务
nssm start LatServer
```

#### 4. 配置防火墙

```powershell
# 添加防火墙规则
New-NetFirewallRule -DisplayName "LAT Game Server" -Direction Inbound -Protocol UDP -LocalPort 5000 -Action Allow
```

### Docker部署

#### 1. 创建Dockerfile

```dockerfile
# Server/LatServer/Dockerfile
FROM mcr.microsoft.com/dotnet/runtime:6.0 AS base
WORKDIR /app

FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build
WORKDIR /src
COPY ["LatServer/LatServer.csproj", "LatServer/"]
COPY ["LatProtocol/LatProtocol.csproj", "LatProtocol/"]
COPY ["LatNet/LatNet.csproj", "LatNet/"]
RUN dotnet restore "LatServer/LatServer.csproj"
COPY . .
WORKDIR "/src/LatServer"
RUN dotnet build "LatServer.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "LatServer.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
EXPOSE 5000/udp
ENTRYPOINT ["dotnet", "LatServer.dll"]
```

#### 2. 构建镜像

```bash
cd Server/LatServer
docker build -t latserver:latest .
```

#### 3. 运行容器

```bash
# 运行容器
docker run -d \
  --name latserver \
  -p 5000:5000/udp \
  --restart unless-stopped \
  latserver:latest

# 查看日志
docker logs -f latserver

# 停止容器
docker stop latserver

# 启动容器
docker start latserver
```

#### 4. 使用Docker Compose

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  gameserver:
    build:
      context: ./Server/LatServer
      dockerfile: Dockerfile
    container_name: latserver
    ports:
      - "5000:5000/udp"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config
    restart: unless-stopped
    networks:
      - game-network

networks:
  game-network:
    driver: bridge
```

运行：
```bash
docker-compose up -d
```

## 客户端打包

### Windows平台

#### 1. 配置Build Settings

1. 打开Unity
2. File → Build Settings
3. 选择Platform：Windows
4. 选择Architecture：x86_64
5. 点击Switch Platform

#### 2. 配置Player Settings

1. Edit → Project Settings → Player
2. 设置Company Name
3. 设置Product Name
4. 设置Version
5. 设置Icon

#### 3. 构建AB包

```bash
# 如果使用YooAsset
# Window → YooAsset → Asset Bundle Collector
# 点击Build
```

#### 4. 打包客户端

1. Build Settings → Build
2. 选择输出目录
3. 等待打包完成

### Mac平台

#### 1. 配置Build Settings

1. File → Build Settings
2. 选择Platform：Mac
3. 选择Architecture：Intel 64-bit或Apple Silicon
4. 点击Switch Platform

#### 2. 打包

1. Build Settings → Build
2. 生成.app文件

### Linux平台

#### 1. 配置Build Settings

1. File → Build Settings
2. 选择Platform：Linux
3. 选择Architecture：x86_64

#### 2. 打包

1. Build Settings → Build
2. 生成可执行文件

### Android平台（可选）

#### 1. 安装Android SDK

1. Unity Hub → Installs
2. 选择Unity版本 → 添加模块
3. 安装Android Build Support

#### 2. 配置

1. Edit → Project Settings → Player → Android
2. 设置Package Name
3. 设置Minimum API Level
4. 配置Keystore

#### 3. 打包

1. File → Build Settings
2. 选择Platform：Android
3. Build or Build And Run

## 服务器监控

### 监控指标

#### 1. 系统监控

```bash
# CPU使用率
top -p $(pgrep -f LatServer)

# 内存使用
ps aux | grep LatServer

# 网络流量
iftop -i eth0
```

#### 2. 应用监控

```bash
# 查看服务状态
systemctl status latserver

# 查看日志
tail -f /var/log/latserver/app.log

# 查看错误
grep ERROR /var/log/latserver/app.log
```

### 日志管理

#### 日志轮转配置

创建 `/etc/logrotate.d/latserver`：

```
/var/log/latserver/*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0644 gameserver gameserver
    sharedscripts
    postrotate
        systemctl reload latserver > /dev/null 2>&1 || true
    endscript
}
```

### 性能优化

#### 1. 系统优化

```bash
# 增加文件描述符限制
echo "gameserver soft nofile 65536" >> /etc/security/limits.conf
echo "gameserver hard nofile 65536" >> /etc/security/limits.conf

# 优化网络参数
sysctl -w net.core.rmem_max=16777216
sysctl -w net.core.wmem_max=16777216
sysctl -w net.ipv4.udp_mem="16384 32768 65536"
```

#### 2. 应用优化

- 使用对象池减少GC
- 优化网络包大小
- 调整KCP参数
- 使用异步I/O

## 备份和恢复

### 数据备份

#### 1. 配置备份脚本

```bash
#!/bin/bash
# /opt/scripts/backup.sh

BACKUP_DIR="/backup/latserver"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份配置
cp -r /opt/latserver/publish/config "$BACKUP_DIR/config_$DATE"

# 备份日志（如果需要）
tar -czf "$BACKUP_DIR/logs_$DATE.tar.gz" /var/log/latserver

# 删除30天前的备份
find $BACKUP_DIR -type f -mtime +30 -delete

echo "Backup completed: $DATE"
```

#### 2. 设置定时任务

```bash
# 编辑crontab
crontab -e

# 每天凌晨2点备份
0 2 * * * /opt/scripts/backup.sh
```

### 灾难恢复

#### 1. 恢复配置

```bash
cp -r /backup/latserver/config_20231225_020000/* /opt/latserver/publish/config/
```

#### 2. 重启服务

```bash
systemctl restart latserver
```

## 负载均衡

### 使用Nginx（可选）

对于需要多服务器部署的场景：

```nginx
# /etc/nginx/nginx.conf

stream {
    upstream game_servers {
        server 192.168.1.10:5000;
        server 192.168.1.11:5000;
        server 192.168.1.12:5000;
    }

    server {
        listen 5000 udp;
        proxy_pass game_servers;
    }
}
```

## 安全加固

### 1. 防火墙配置

只开放必要端口：
```bash
# 只允许游戏端口
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 5000/udp
sudo ufw enable
```

### 2. 使用非root用户

```bash
# 创建专用用户
sudo useradd -r -s /bin/false gameserver

# 设置文件权限
sudo chown -R gameserver:gameserver /opt/latserver
sudo chmod 750 /opt/latserver
```

### 3. 定期更新

```bash
# 定期更新系统
sudo apt update && sudo apt upgrade

# 更新.NET运行时
sudo apt install --only-upgrade dotnet-runtime-6.0
```

## 故障排查

### 常见问题

#### Q1: 服务无法启动
```bash
# 查看详细日志
sudo journalctl -u latserver -n 100 --no-pager

# 检查端口占用
sudo netstat -tulpn | grep 5000

# 检查文件权限
ls -la /opt/latserver/publish/
```

#### Q2: 客户端无法连接
```bash
# 测试端口连通性
nc -u -v server_ip 5000

# 检查防火墙
sudo ufw status

# 查看服务器日志
tail -f /var/log/latserver/app.log
```

#### Q3: 性能问题
```bash
# CPU profiling
dotnet-trace collect --process-id $(pgrep -f LatServer)

# 内存分析
dotnet-dump collect --process-id $(pgrep -f LatServer)
```

## 更新部署

### 零停机更新

1. **启动新版本服务器**
   ```bash
   # 在新端口启动新版本
   dotnet LatServer.dll --port 5001
   ```

2. **迁移玩家**
   - 停止接受新连接
   - 等待现有连接结束
   - 关闭旧服务器

3. **切换流量**
   ```bash
   # 更新负载均衡配置
   # 重新加载nginx
   sudo nginx -s reload
   ```

## 相关文档

- [项目总览](01-项目总览.md)
- [技术栈详解](02-技术栈.md)
- [服务端架构](04-服务端架构.md)
- [开发指南](07-开发指南.md)
